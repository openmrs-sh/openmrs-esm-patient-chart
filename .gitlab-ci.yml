image: node:18-alpine
stages:
  - build
  - package-publish
  # - trigger-distro-build

build:
  image: node:18-alpine
  stage: build
  tags:
    - docker-runner
  script:
    - apk update && apk add git
    - yarn install
    - yarn up
    - cd ./packages/esm-patient-chart-app/
    - yarn add semver
    - yarn add -D webpack-cli
    - yarn install
    - yarn up
    - yarn run build    
  artifacts:
    paths:
      - packages/esm-patient-chart-app/
pre-release:
  image: node:18-alpine
  stage: package-publish
  tags:
    - docker-runner
  script:
    - cd ./packages/esm-patient-chart-app/
    - npm version --legacy-peer-deps --no-git-tag-version "$(node -e "console.log(require('semver').inc(require('./package.json').version, 'patch'))")-pre.$CI_PIPELINE_ID"
    - yarn npm publish --tag next
# trigger_job:
#   stage: trigger-distro-build
#   only:
#     - main
#   trigger:
#     project: openmrs/ozone-simc
